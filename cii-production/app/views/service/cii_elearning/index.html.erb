<% content_for :title, "Manage ESG Premium Subscription: Video Uploads " %>
<% content_for :description, "Efficiently manage and approve ESG premium subscription videos and requests with ease." %>
<style type="text/css">
  input {
    cursor: pointer;
  }
  
  input::-webkit-calendar-picker-indicator {
    cursor: pointer;
  }

  .file-name-thumbnail {
    max-width: 400px; 
    word-wrap: break-word;
    white-space: normal;
    display: inline-block; 
    overflow-wrap: break-word; 
}
</style>
<div class="pb-4">
    <div class="navbar-nav-right d-flex align-items-center">
        <div class="navbar-nav align-items-center">
            <div class="nav-item d-flex align-items-center">
        <div class="col-12 d-flex">
        <div class="col-4 mx-1 filter-width-publication">
            <input type="text" name="search" id="companyNameFilter" class="form-control date-filter-text" placeholder="Search by Name" value="<%= @company_name ? @company_name : "" %>">
        </div>
        <div class="col-3 mx-1 filter-width-publication">
            <input type="date" class="form-control date-filter-text" id="year-picker" data-placeholder="Select a date" style="cursor: text;" webkitdirectory />
        </div>
        <div class="col-1 mx-1" style="width: auto">
            <%= button_tag "Apply", class: "btn btn-md btn-primary", id: "apply-filter" %>
        </div>
        <div class="col-3 mx-1">
            <%= button_tag "Clear", class: "btn btn-md btn-secondary", id: "clear-filter" %>
        </div>
        </div>
            </div>
        </div>
        <ul class="navbar-nav flex-row align-items-center ms-auto">
            <li class="nav-item lh-1" style="margin-left: 6px; margin-right: 6px;">
                <div class="add-company-button">
                <%= button_tag "Upload", class: "btn btn-primary", id: "add_company" %>
                </div>
            </li>
        </ul>
    </div>
</div>
<div class="card">
<div class="tab-content">
	<div class="table-responsive text-nowrap set-height" id="users-table">
		<%= render 'service/cii_elearning/learning_user_table', elearnings: @company_users %>
	</div>
</div>
</div>

<div class="modal fade" id="modalElearningDelete" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
    <div class="modal-content">
      <div class="alert alert-danger alert-dismissible" role="alert"></div>
      <div class="modal-body">
        <p>Are you sure you want to delete this file?</p>
        <input type="hidden" id="delete_user_id">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="delete_button">Yes</button>
        <button type="button" class="btn btn-secondary" id="delete_cancel" data-bs-dismiss="modal">No</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalAddElearning" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
     <div class="modal-header">
        <h5 class="modal-title add-company-text">Add E-Learning</h5>
      </div>
      <div class="modal-body">
        <%= form_tag(elearning_creation_path, multipart: true, id: "elearning_creation") do %>
          <div class="mb-4">
            <label class="">Title<span class="text-danger fs-6">*</span></label>
            <%= text_field_tag :company_name, nil, class: "form-control mandatory-field", placeholder: "Enter the title", id: "elearning_title_field" %>
          </div>
          <div id="service_section"  class="mb-3">
            <%= radio_button_tag :service, 'paid', false, id: 'service_paid' %>
            <%= label_tag :service_paid, 'Paid' %>
            <span style="margin-left: 15px;">
              <%= radio_button_tag :service, 'free', false, id: 'service_free'%>
              <%= label_tag :service_free, 'Free' %>
            </span>
          </div>
          <div id="priceFieldContainer" class="mb-4 d-none">
            <label class="mb-2">Price </label>
            <%= text_field_tag :price, nil, class: "form-control", placeholder: "Enter Price", id: "elearning_price_field" %>
          </div>
          <div class="mb-3">
           <label class="mb-2">Upload Video<span class="text-danger fs-6">*</span> </label>
            <%= file_field_tag "videofile", class: "form-control mandatory-field", accept: "video/mp4" %>
            <div class="pdf-img" style="margin-top:10px">
              <i class="bx bx-video icon-align-video" style="font-size: 3rem; margin: 0.125rem;"></i>
              <span class="file-name" style="font-size:15px"></span>
            </div>
          </div>
          <div class="mb-5">
            <label class="mb-2">Thumbnail</label>
            <%= file_field_tag "thumbnail", class: "form-control", accept: "image/*" %>
            <div class="pdf-img-thumb" style="margin-top:10px">
              <span class="file-name-thumbnail" style="font-size:15px;"></span>
            </div>
          </div>
          <%= text_field_tag :company_id, nil, class: "form-control d-none", id: 'companydetails_id' %>
          <div class="modal-footer mt-2" style="justify-content: center !important; padding: 0">
            <button type="submit" class="btn btn-primary save-company" data-value="Submit" id="add_elearning_submit">Submit</button>
            <button type="button" class="btn btn-secondary company-cancel" data-bs-dismiss="modal">Cancel</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalElearningPayment" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="alert alert-danger alert-dismissible" role="alert"></div>
       <div class="modal-body">
       <button type="button" class="btn-close float-right" style="box-shadow: revert;position: relative; top: 15px; right: 15px" data-bs-dismiss="modal" aria-label="Close"></button>
        <table class="table">
        <input type="hidden" id="elearning_payment_id">
          <thead>
            <tr>
              <th class="text-center">S.No</th>
              <th class="text-center">Company Name</th>
              <th class="text-center">Payment Approval</th>
            </tr>
          </thead>
          <tbody id="videoTableBody">
      
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalbasicApprove" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
    <div class="modal-content">
      <div class="alert alert-danger alert-dismissible" role="alert"></div>
      <div class="modal-body">
        <p>Are you sure you want to approve?</p>
        <input type="hidden" id="approve_basic_user_id" value="">
        <input type="hidden" id="company_approve_user_id" value="">
        <input type="hidden" id="elearning_payment_id" value="">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="approve_basic_button">Yes</button>
        <button type="button" class="btn btn-secondary cancelPaymentApproval" data-bs-dismiss="modal" id="cancelModalBtn">No</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalbasicReject" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
    <div class="modal-content">
      <div class="alert alert-danger alert-dismissible" role="alert"></div>
      <div class="modal-body">
        <div class="row">
          <div class="col mb-3">
            <label class="form-label">Reason for rejection</label>
            <textarea id="basic_reason_for_rejection" class="form-control" placeholder="Enter reason"></textarea>
            <input type="hidden" id="reject_basic_user_id">
            <input type="hidden" id="company_reject_user_id">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="reject_basic_service_button">Reject</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelRejectModalBtn">Cancel</button>
      </div>
    </div>
  </div>
</div>


<div class="col-md-12 pagination-alignments">
    <%= will_paginate @company_users %>
</div>

<script>
  var year_value = `<%= params[:year] %>`
    $(document).on('turbolinks:load', function () {
      let submitCheck = false
        $(".alert-dismissible").hide();  
        $('#modalAddElearning, #modalElearningPayment').modal({ backdrop: 'static', keyboard: false });

        $(document).on("click", "#clear-filter", function (event) {
            event.stopPropagation();
            window.location.replace("<%= elearning_admin_dashboard_path %>");
        });

        $(document).on("click", "#apply-filter", function (event) {
            event.stopPropagation();

            $(".filter-container").hide();

            applyFilter(event);
        });


        $(document).on("click", ".delete_button", function (event) {
            event.stopPropagation();

            $("#delete_user_id").val(this.name);
        });

        $(document).on("click", ".payment-approval", function (event) {
          event.stopPropagation();

          $("#elearning_payment_id").val(this.name);
        });


    $(document).ready(function() {
      $('#modalElearningPayment').on('show.bs.modal', function(event) {
          var button = $(event.relatedTarget); 
          var learning_id = button.data('learning-id');
          $('#elearning_payment_id').val(learning_id);
          fetchElearningDetails(learning_id);
      });

        function fetchElearningDetails(learning_id) {
          $.ajax({
              url: '/service/cii_elearning/fetch_details',
              type: 'GET',
              data: { learning_id: learning_id },
              success: function(data) {
                  var details = data;
                  var tableBody = $('#videoTableBody');
                  tableBody.empty();
                  
                  if (details.length === 0) {
                    var noCompanyRow = `<tr>
                      <td colspan="3" class="text-center">No company available</td>
                    </tr>`;
                    tableBody.append(noCompanyRow);
                  } else {
                            details.forEach(function(detail, index) {
                              var buttonHtml = '';
                              
                              if (detail.status === 'approved') {
                                  buttonHtml = `<span class="badge bg-success p-1"><i class='bx bx-check fs-4'></i></span>`;
                              } else if (detail.status === 'rejected') {
                                  buttonHtml = `<span class="badge bg-danger p-1"><i class='bx bx-x fs-4'></i></span>`;
                              } else {
                                  buttonHtml = `
                                      <button type="button" class="btn btn-xs btn-success approve_button" data-company-id="${detail.user_id}" data-learning-id="${detail.elearning_id}"><i class='bx bx-check fs-4'></i></button>
                                      <button type="button" class="btn btn-xs btn-danger reject_button" data-company-id="${detail.user_id}" data-learning-id="${detail.elearning_id}"><i class='bx bx-x fs-4'></i></button>
                                  `;
                              }
                              
                              var row = `<tr>
                                            <td class="text-center">${index + 1}</td>
                                            <td class="text-center">${detail.company_name}</td>
                                            <td class="text-center">${buttonHtml}</td>
                                        </tr>`;
                              tableBody.append(row);
                              });
                          }

                  $('.approve_button').on('click', function() {
                      var learning_id = $('.approve_button').data('learning-id');
                      var company_id = $('.approve_button').data('company-id');
                      $('#approve_basic_user_id').val(learning_id);
                      $('#company_approve_user_id').val(company_id);
                      $('#modalElearningPayment').addClass('modal-blur');
                      $('#modalbasicApprove').modal('show');
                  });

                  $('.reject_button').on('click', function() {
                      var learning_id = $(this).data('learning-id');
                      var company_id = $(this).data('company-id');
                      $('#reject_basic_user_id').val(learning_id);
                      $('#company_reject_user_id').val(company_id);
                      $('#modalElearningPayment').addClass('modal-blur');
                      $('#modalbasicReject').modal('show');
                  });
              },
              error: function(xhr, status, error) {
                  console.error('Failed to fetch details:', error);
              }
          });
        }

        $('#modalbasicApprove').on('hidden.bs.modal', function() {
            $('#modalElearningPayment').removeClass('modal-blur');
        });

        $('#modalbasicReject').on('hidden.bs.modal', function() {
            $('#modalElearningPayment').removeClass('modal-blur');
        });

        $(document).on("click", "#approve_basic_button", function(event) {
          event.stopPropagation();

            let elearning_id = $("#approve_basic_user_id").val();
            let company_id = $("#company_approve_user_id").val();
            $("#approve_basic_button").prop("disabled", true)
            $("#cancelModalBtn").prop("disabled", true)
            $.ajax({
              type: "PATCH",
              url: '/service/cii_elearning/update_status/approved',
              data: { elearning_id: elearning_id, company_id: company_id },
              beforeSend: function(xhr) {
                  xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
              },
              processData: true,
              success: function(data) {
                  $("#modalbasicApprove").modal('hide');
                  fetchElearningDetails($('#elearning_payment_id').val());
              },
              error: function(err) {
                  $(".alert-dismissible").html("Unable to approve.").show().delay(3000).fadeOut(300);
              }
          });
        });
      });

        $(document).on("click", "#reject_basic_service_button", function (event) {
          event.stopPropagation();

          let reason = $("#basic_reason_for_rejection").val();
          let elearning_id = $("#reject_basic_user_id").val();
          let company_id = $("#company_reject_user_id").val();

         $("#reject_basic_service_button").prop("disabled", true)
         $("#cancelRejectModalBtn").prop("disabled", true)
          if (reason !== "") {
              $.ajax({
                  type: "PATCH",
                  url: '/service/cii_elearning/update_status/rejected',
                  data: { elearning_id: elearning_id, reason: reason, company_id: company_id },
                  beforeSend: function (xhr) {
                      xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
                  },
                  processData: true,
                  success: function (data) {
                      $("#modalbasicReject").hide();
                  },
                  error: function (err) {
                      console.log(err);
                  }
              });
          } else {
              $(".alert-dismissible").html("Please enter reason for rejection.").show().delay(3000).fadeOut(300);
          }
        });


        $(document).on("click", "#delete_button", function (event) {
          event.stopPropagation();

          let user_id = $("#delete_user_id").val();
          let $deleteButton = $(this);
          let $cancelButton = $("#delete_cancel")
          $cancelButton.prop("disabled", true);
          $deleteButton.prop("disabled", true);

          $.ajax({
              type: "DELETE",
              url: '/service/cii_elearning/destroy',
              data: { user_id: user_id },
              beforeSend: function (xhr) {
                  xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
              },
              processData: true,
              success: function (data) {
                  $("#modalDelete").hide();
                  location.reload()
              },
              error: function (err) {
                  $(".alert-dismissible").html("Unable to delete.").show().delay(3000).fadeOut(300);
                  $deleteButton.prop("disabled", false);
                }
            });
        });


        function applyFilter(event) {
            event.preventDefault();

            $(".filter-container").hide();
            $("#analyst_id, #assign").attr('disabled', 'disabled');
            $("#analyst_id").val('');

            let companyName = $("#companyNameFilter").val();
            let searchYear = $("#year-picker").val();
            $(".sector-checkbox:checkbox:checked").each(function () {
                sectorIds.push(Number(this.value));
            });
            window.location.replace("<%= elearning_admin_dashboard_path %>?companyName="+companyName+"&year="+searchYear)
        }

        function setDateFromURL() {
            const params = new URLSearchParams(window.location.search);
            const year = params.get('year');
            if (year) {
                $("#year-picker").val(year);
            }
        }

        // Call the function on page load
        $(document).ready(function() {
            setDateFromURL();
        });

    });

    $(document).ready(function() {

        $(document).on("click", ".filter-icon", function (event) {
            event.stopPropagation();

            $(".filter-container").toggle();
        });  
    });

  function editCompany(e){
    handleRadioBtn()
    submitCheck = true
    var $submitButton = $('#add_elearning_submit');
    $('#elearning_title_field').addClass('edit-mandatory-check')
    $('#elearning_price_field').addClass('edit-mandatory-check')
    var $serviceSection = $('#service_section');
    var $priceFieldContainer = $('#priceFieldContainer');
    $('.save-company').attr('data-value', 'Update');
    $('.pdf-img-thumb').addClass('d-none')
    $submitButton.prop('disabled', false);
    $priceFieldContainer.addClass('d-none');
    $priceFieldContainer.removeClass('mandatory-field');
    $.ajax({
    type: "GET",
    url: "/service/cii_elearning/fetch_elearning",
    data: { company_id: e },
    beforeSend: function (xhr) {
        xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
    },
    processData: true,
    success: function (result) {
      $("#videofile").prop("required", false);
      $('#companydetails_id').val(result.company_data.id)
      $('#elearning_title_field').val(result.company_data.title)
      $('#elearning_price_field').val(result.price)
      $('.file-name').text(result.filename)
      $('.file-name-thumbnail').text(result.thumbnail)
      if(result.filename != null){
        $('.pdf-img').removeClass('d-none')
      }
      if(result.thumbnail != null){
        $('.pdf-img-thumb').removeClass('d-none')
      }
      $('.save-company').text('Update')
      $('.add-company-text').text('Update E-Learnings')
      $('#hidden_company_name').val(result.company_data.title);
      $('.save-company').attr('data-value', 'Update');
      if (result.company_data.service === 'paid') {
        $priceFieldContainer.removeClass('d-none');
        $priceFieldContainer.addClass('mandatory-field');
        $('#service_paid').prop("checked", true)
      }
      else {
        $('#service_free').prop("checked", true)
      }
      $('#modalAddElearning').modal('show');
    }
    });
    var submitDataValue = $('.save-company').attr('data-value').trim();
    if (submitDataValue == "Update") {
      function checkFields() {
        var isTitleEmpty = $('#elearning_title_field').val().trim() === '';
        var isPriceEmpty = $('#elearning_price_field').val().trim() === '';
        $submitButton.prop('disabled', isTitleEmpty );
        if ($('#service_paid').is(':checked')) {
          $submitButton.prop('disabled', isPriceEmpty || isTitleEmpty );
        }
      }
        $('input[name="service"]').on('change', function() {
          if ($('#service_paid').is(':checked')) {
             checkFields();
          }
        });
      $('.edit-mandatory-check').off('keyup').on('keyup', function(e){
       if (submitCheck) {
          checkFields();
       }
      });
    }
  }

    if (year_value != "") {
      $('.select-year-font').css("color", "black")
    }; 

    $(document).on('click', '[data-bs-toggle="modal"]', function () {
      var userId = $(this).data('user-id');
      $('#company_user_id').val(userId);
    });

function handleRadioBtn() {
  $('input[name="service"]').on('change', function() {
    if ($('#service_paid').is(':checked')) {
        $('#priceFieldContainer').removeClass('d-none');
        $('#elearning_price_field').addClass('mandatory-field');
    } else {
        $('#priceFieldContainer').addClass('d-none');
        $('#elearning_price_field').removeClass('mandatory-field');
        $('#elearning_price_field').val('')
    }
  });
}

$(document).ready(function() {
  var $form = $('#elearning_creation');
  var $companyNameField = $('#elearning_title_field');
  var $companyPriceField = $('#elearning_price_field');
  var $addCompanyModal = $('#modalAddElearning');
  var $submitButton = $('#add_elearning_submit');
  var $mandatoryFields = $('.mandatory-field');
  var $companyCancel = $('.company-cancel');
  var $serviceSection = $('#service_section');
  var $priceFieldContainer = $('#priceFieldContainer');
  var $serviceRadios = $('input[name="service"]');
  var isPriceValue = true;
  $('input[name="service"]').on('change', function() {
    if ($('#service_paid').is(':checked')) {
      if ($companyPriceField.val() == "") {
        var isPriceValue = false
      }
    }
  });

  $companyPriceField.on('keyup', function() {
    checkMandatoryFields()
  })

  function checkMandatoryFields() {
    var buttonText = $('#add_elearning_submit').attr('data-value').trim();
    if (buttonText === "Submit") {
      var allFilled = true;
      $mandatoryFields.each(function() {
        if ($.trim($(this).val()) === '') {
          allFilled = false;
          return false; 
        }
    });
    var isPriceValue = true;
    
    if ($('#service_paid').is(':checked')) {
      if ($companyPriceField.val() == "") {
        isPriceValue = false
      } else {
        isPriceValue = true
      }
    }
    var isServiceSelected = $serviceRadios.is(':checked');
    $submitButton.prop('disabled', !(allFilled && isServiceSelected && isPriceValue));
    }
  }
  $mandatoryFields.on('input', checkMandatoryFields);
  $serviceRadios.on('change', checkMandatoryFields);
  checkMandatoryFields();
  $form.on('submit', function(event) {
    event.preventDefault();
    var companyName = $companyNameField.val();
    if (companyName === '') {
      event.preventDefault();
      return false;
    }
    $form.off('submit').submit();
    var $submitButton = $('#add_elearning_submit');
    $submitButton.prop('disabled', true);
    $('.company-cancel').prop('disabled', true);
    $('#modalAddElearning').modal('hide');
    showLoader()
  });

  $('#add_company').click(function() {
    submitCheck = false
    $('#elearning_title_field').removeClass('edit-mandatory-check')
    $('#elearning_price_field').removeClass('edit-mandatory-check')
    var $submitButton = $('#add_elearning_submit');
    $submitButton.prop('disabled', true);
    $('#elearning_title_field').val('')
    $('#companydetails_id').val('')
    $('.pdf-img').addClass('d-none')
    $('.pdf-img-thumb').addClass('d-none')
    $('.add-company-text').text('Add E-Learnings')
    $('.save-company').text('Submit')
    $serviceSection.removeClass('d-none');
    $priceFieldContainer.addClass('d-none');
    $('.save-company').attr('data-value', 'Submit');
    $('#service_paid').prop("checked", false);
    $('#service_free').prop("checked", false)
    $('#elearning_price_field').val('')
    $('#videofile').val('')
    $('#modalAddElearning').modal('show');
    checkMandatoryFields();
    handleRadioBtn()
  });
});

function debounce(func, wait) {
  var timeout;
  return function() {
    var context = this, args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(function() {
      func.apply(context, args);
    }, wait);
  };
}

function showLoader() {
    document.getElementById("loader-wrapper").style.display = "block";
    $('.card').css('filter','blur(4px)');
  }
function hideLoader() {
    document.getElementById("loader-wrapper").style.display = "none";
    $('.card').css('filter','blur(0px)');
}

</script>

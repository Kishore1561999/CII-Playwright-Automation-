<% content_for :title, "User Management | Seamlessly Create, Edit, & Delete Users" %>
<% content_for :description, "Streamline user management with powerful tools to create, edit, and delete admin users. Enhance your control and efficiency effortlessly." %>
<div class="card">
	<div class="card-header">
		<h5>Users</h5>
		<div class ="col-md-12" align="right">
			<%= link_to "Create New CII User", new_user_path, :class => "btn btn-primary" %>
		</div>
	</div>
	<div class="table-responsive text-nowrap">
		<table class="table table-hover">
			<thead>
				<tr class="text-nowrap">
					<th>Full Name</th>
					<th>Email</th>
					<th>Mobile</th>
					<th>Role</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody class="table-border-bottom-0">
				<% if @users.length > 0 %>
					<% @users.each do |user| %>
						<tr>
							<td><strong><%= "#{user.first_name} #{user.last_name}" %></strong></td>
							<td><%= user.email %></td>
							<td><%= user.mobile %></td>
							<td class="role-name"><%= user.role.role_name.humanize %></td>
							<td>
								<div class="dropdown">
									<button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
										<i class="bx bx-dots-vertical-rounded"></i>
									</button>
									<div class="dropdown-menu">
										<%= link_to user_path(user.id), class: "dropdown-item" do %>
											<i class="bx bx-show me-1"></i> View
										<% end %>
										<%= link_to edit_user_path(user.id), class: "dropdown-item" do %>
											<i class="bx bx-edit-alt me-1"></i> Edit
										<% end %>
										<%= link_to "#", class: "dropdown-item delete_button", 'data-bs-toggle': "modal", 'data-bs-target': "#modalDelete", name: user.id do %>
											<i class="bx bx-trash me-1"></i> Delete
										<% end %>
									</div>
								</div>
							</td>
						</tr>
					<% end %>
				<% else %>
					<tr>
						<td colspan="5" class="text-center">No data available!</td>
					</tr>
				<% end %>
			</tbody>
		</table>
	</div>
</div>

<div class="modal fade" id="modalDelete" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-sm" role="document">
		<div class="modal-content">
			<div class="alert alert-danger alert-dismissible" role="alert"></div>
			<div class="modal-body">
				<p>Are you sure you want to delete?</p>
				<input type="hidden" id="delete_user_id">
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="delete_button">Yes</button>
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
			</div>
		</div>
	</div>
</div>

<script>
  $(document).ready(function() {
		$(".alert-dismissible").hide();

		$(".delete_button").click(function() {
			$("#delete_user_id").val(this.name);
		});

		$("#delete_button").click(function() {
			let user_id = $("#delete_user_id").val();

			$.ajax({
				type: "DELETE",
				url: `/esgadmin/users/${user_id}`,
				beforeSend: function (xhr) {
					xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
				},
				processData: false,
				success: function(data) {
					$(".modalCenter").hide();
				},
				error: function(err) {
					$(".alert-dismissible").html("Unable to delete.").show().delay(3000).fadeOut(300);
				}
			});
    });
  });
</script>

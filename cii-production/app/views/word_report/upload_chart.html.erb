<img src="" id="graphImage" style="display: none !important;">
<canvas id="myChart" style="width:100%; max-width:700px; display: none !important;"></canvas>

<script>
    function chartToImage() {
        var canvas = document.getElementById("myChart");
        document.getElementById("graphImage").src = canvas.toDataURL("image/jpg");

        var file = dataURLtoFile(canvas.toDataURL("image/jpg"), 'image.jpg');
        var fd = new FormData();
        fd.append("image", file);

        $.ajax({
            url: "/upload_graph_image/<%= @company_user_id %>",
            type: "POST",
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
            },
            data: fd,
            processData: false,
            contentType: false,
            success: function (data) {
                <% if current_user.is_admin? %>
                                window.location.replace('<%= admin_company_users_path(doc_id: @company_user_id) %>');
                <% elsif current_user.is_manager? %>
                                window.location.replace('<%= manager_company_users_path(doc_id: @company_user_id) %>');
                <% elsif current_user.is_analyst? %>
                                window.location.replace('<%= analyst_dashboard_path(doc_id: @company_user_id) %>');
                <% else %>
                                window.location.replace('/');
                <% end %>
            }
        });
    }

    function dataURLtoFile(dataURL, fileName) {
        var arr = dataURL.split(','),
          mime = arr[0].match(/:(.*?);/)[1],
          bstr = atob(arr[1]),
          n = bstr.length,
          u8arr = new Uint8Array(n);

        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }

        return new File([u8arr], fileName, {type: mime});
    }

    function loadChart() {
        return new Promise(function (resolve, reject) {
            try {
                var ctx = document.getElementById('myChart').getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: <%= @graph_labels.to_json.html_safe %>,
                        datasets: [{
                            label: 'Score Analytics',
                            data: <%= @graph_values.to_json.html_safe %>,
                            backgroundColor: [
                                <% @graph_values.each do |value| %>
                                '<%= case value
                      when (96..100)
                        'rgba(75, 175, 50, 1)'
                      when (86..95.99)
                        'rgba(141, 217, 121, 1)'
                      when (76..85.99)
                        'rgba(179, 229, 166, 1)'
                      when (71..75.99)
                        'rgba(255, 255, 0, 1)'
                      when (61..70.99)
                        'rgba(255, 255, 102, 1)'
                      when (51..60.99)
                        'rgba(255, 255, 195, 1)'
                      when (36..50.99)
                        'rgba(255, 161, 139, 1)'
                      when (21..35.99)
                        'rgba(255, 87, 47, 1)'
                      when (0..20.99)
                        'rgba(225, 0, 0, 1)'
                      else
                        'rgba(225, 0, 0, 1)'
                    end %>',
                                <% end %>
                            ],
                        }]
                    },
                    options: {
                        "animation": {
                            "duration": 1,
                            "onComplete": function() {
                                var chartInstance = this.chart,
                                  ctx = chartInstance.ctx;

                                ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
                                ctx.fillStyle = "#0c0c0c";
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'bottom';

                                this.data.datasets.forEach(function(dataset, i) {
                                    var meta = chartInstance.controller.getDatasetMeta(i);
                                    meta.data.forEach(function(bar, index) {
                                        var data = dataset.data[index];
                                        ctx.fillText(data, bar._model.x, bar._model.y - 5);
                                    });
                                });
                            }
                        },
                        events: [],
                        layout: {
                            padding: {
                                right: 0,
                                left: 20,
                                top: 10,
                            }
                        },
                        scales: {
                            pointLabels: {
                                fontStyle: "bold",
                            },
                            y: {
                                beginAtZero: true
                            },
                            yAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: '      ',
                                    fontSize: 13,
                                },
                                gridLines: {
                                    color: "rgba(0, 0, 0, 0)",
                                },
                                ticks: {
                                    fontColor: "#0c0c0c",
                                    fontFamily: "'Calibri', sans-serif",
                                    beginAtZero: true,
                                    steps: 10,
                                    stepValue: 5,
                                    max: 100
                                }
                            }],
                            xAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: '      ',
                                    fontSize: 13,
                                },
                                gridLines: {
                                    color: "rgba(0, 0, 0, 0)",
                                },
                                ticks: {
                                    fontColor: "#0c0c0c",
                                    fontFamily: "'Calibri', sans-serif",
                                },
                            }],
                        },
                        legend: {
                            labels: {
                                boxWidth: 0,
                                fontSize: 22,
                                fontFamily: "'Calibri', sans-serif",
                                fontColor: "#00b050",
                                fontStyle: "lighter",
                            },
                            onClick: (e) => e.stopPropagation(),
                            displayColors: false
                        },
                    }
                });
                resolve("Working")
            } catch (err) {
                console.log(err)
                reject(err)
            }
        });
    }

    loadChart().then(data => {
        setTimeout(function () {
            chartToImage();
        }, 800);
    }).catch(err => {
        console.log(err);
    });
</script>

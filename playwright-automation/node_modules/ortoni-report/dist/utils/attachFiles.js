import path from "path";
import fs from "fs";
import { convertMarkdownToHtml } from "../helpers/markdownConverter";
export function attachFiles(subFolder, result, testResult, config, steps, errors) {
    const folderPath = config.folderPath || "ortoni-report";
    const attachmentsFolder = path.join(folderPath, "ortoni-data", "attachments", subFolder);
    if (!fs.existsSync(attachmentsFolder)) {
        fs.mkdirSync(attachmentsFolder, { recursive: true });
    }
    if (!result.attachments)
        return;
    const { base64Image } = config;
    testResult.screenshots = [];
    testResult.videoPath = [];
    result.attachments.forEach((attachment) => {
        const { contentType, name, path: attachmentPath, body } = attachment;
        if (!attachmentPath && !body)
            return;
        const fileName = attachmentPath
            ? path.basename(attachmentPath)
            : `${name}.${getFileExtension(contentType)}`;
        const relativePath = path.join("ortoni-data", "attachments", subFolder, fileName);
        const fullPath = path.join(attachmentsFolder, fileName);
        if (contentType === "image/png") {
            handleImage(attachmentPath, body, base64Image, fullPath, relativePath, testResult);
        }
        else if (name === "video") {
            handleAttachment(attachmentPath, fullPath, relativePath, "videoPath", testResult);
        }
        else if (name === "trace") {
            handleAttachment(attachmentPath, fullPath, relativePath, "tracePath", testResult);
        }
        else if (name === "error-context") {
            handleAttachment(attachmentPath, fullPath, relativePath, "markdownPath", testResult, steps, errors);
        }
    });
}
function handleImage(attachmentPath, body, base64Image, fullPath, relativePath, testResult) {
    let screenshotPath = "";
    if (attachmentPath) {
        try {
            const screenshotContent = fs.readFileSync(attachmentPath, base64Image ? "base64" : undefined);
            screenshotPath = base64Image
                ? `data:image/png;base64,${screenshotContent}`
                : relativePath;
            if (!base64Image) {
                fs.copyFileSync(attachmentPath, fullPath);
            }
        }
        catch (error) {
            console.error(`OrtoniReport: Failed to read screenshot file: ${attachmentPath}`, error);
        }
    }
    else if (body) {
        screenshotPath = `data:image/png;base64,${body.toString("base64")}`;
    }
    if (screenshotPath) {
        testResult.screenshots?.push(screenshotPath);
    }
}
function handleAttachment(attachmentPath, fullPath, relativePath, resultKey, testResult, steps, errors) {
    if (attachmentPath) {
        fs.copyFileSync(attachmentPath, fullPath);
        if (resultKey === "videoPath") {
            testResult[resultKey]?.push(relativePath);
        }
        else if (resultKey === "tracePath") {
            testResult[resultKey] = relativePath;
        }
    }
    if (resultKey === "markdownPath" && errors) {
        const htmlPath = fullPath.replace(/\.md$/, ".html");
        const htmlRelativePath = relativePath.replace(/\.md$/, ".html");
        convertMarkdownToHtml(fullPath, htmlPath);
        testResult[resultKey] = htmlRelativePath;
        return;
    }
}
function getFileExtension(contentType) {
    const extensions = {
        "image/png": "png",
        "video/webm": "webm",
        "application/zip": "zip",
        "text/markdown": "md",
    };
    return extensions[contentType] || "unknown";
}
